<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Debug Test</title>
</head>
<body>
    <h1>Frontend Acknowledgment Debug Test</h1>
    <div id="status">Connecting...</div>
    <div id="log"></div>
    
    <script>
        let websocket = null;
        let isConnected = false;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        function sendWebSocketMessage(message) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(message));
                log('üì§ Sent: ' + JSON.stringify(message));
            } else {
                log('‚ö†Ô∏è WebSocket not connected, message not sent');
            }
        }
        
        function resizeCanvas(width, height, commandId = null) {
            log(`üé® resizeCanvas called: ${width}x${height}, commandId: ${commandId}`);
            log(`üîó isConnected: ${isConnected}`);
            
            try {
                // Simulate canvas resize
                log('‚úÖ Canvas resize simulated successfully');
                
                // Send acknowledgment back to backend
                if (isConnected) {
                    const ackMessage = {
                        type: 'canvas_command_ack',
                        command: 'edit_canvas_size',
                        status: 'success',
                        data: {
                            requested_width: width,
                            requested_height: height,
                            actual_width: width,
                            actual_height: height,
                            command_id: commandId,
                            timestamp: new Date().toISOString()
                        },
                        message: `Canvas successfully resized to ${width}x${height}`
                    };
                    
                    sendWebSocketMessage(ackMessage);
                    log('üì§ Acknowledgment sent');
                } else {
                    log('‚ùå Not connected - acknowledgment not sent');
                }
                
                return true;
            } catch (error) {
                log('‚ùå Error in resizeCanvas: ' + error.message);
                return false;
            }
        }
        
        function executeCanvasCommand(command, data, commandId = null) {
            log(`üé® executeCanvasCommand: ${command}, commandId: ${commandId}`);
            
            switch (command) {
                case 'edit_canvas_size':
                    resizeCanvas(data.width, data.height, commandId);
                    break;
                default:
                    log('‚ö†Ô∏è Unknown canvas command: ' + command);
            }
        }
        
        function handleWebSocketMessage(message) {
            log('üì• Received: ' + JSON.stringify(message));
            
            switch (message.type) {
                case 'handshake_response':
                    log('ü§ù Handshake successful');
                    updateStatus('Connected');
                    break;
                    
                case 'initial_state':
                    log('üìã Initial state received');
                    break;
                    
                case 'canvas_command':
                    executeCanvasCommand(message.command, message.data, message.command_id);
                    break;
                    
                default:
                    log('‚ö†Ô∏è Unknown message type: ' + message.type);
            }
        }
        
        function initializeWebSocket() {
            const wsUrl = `ws://${window.location.host}/ws`;
            log('üì° Connecting to: ' + wsUrl);
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    log('‚úÖ WebSocket connected');
                    isConnected = true;
                    updateStatus('Connected');
                    
                    // Send handshake
                    sendWebSocketMessage({
                        type: 'handshake',
                        data: {
                            clientType: 'debug_test_frontend',
                            version: '0.1.0'
                        }
                    });
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleWebSocketMessage(message);
                    } catch (error) {
                        log('‚ùå Error parsing message: ' + error.message);
                    }
                };
                
                websocket.onclose = function(event) {
                    log('üîå WebSocket disconnected');
                    isConnected = false;
                    updateStatus('Disconnected');
                };
                
                websocket.onerror = function(error) {
                    log('‚ùå WebSocket error: ' + error);
                };
                
            } catch (error) {
                log('‚ùå Failed to initialize WebSocket: ' + error.message);
                updateStatus('Error');
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeWebSocket();
        });
    </script>
</body>
</html> 